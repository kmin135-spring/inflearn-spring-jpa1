# 개요

* 김영한 - 실전! 스프링 부트와 JPA 활용 1편 

# h2 데이터베이스 세팅

1. 직접다운받은 h2 를 실행 `h2/bin/h2.bat`
2. go to `http://localhost:8082/`
3. JDBC URL을 `jdbc:h2:~/jpashop` 로 입력 후 연결 (최초 1회)
   * `~/jpashop.mv.db` 가 생성되면 정상
4. 연결 해제 후 이후에는  `jdbc:h2:tcp://localhost/~/jpashop` 로 접속

# 메모

* N:M 은 운영에서는 쓰지 않는다. 1:N, N:1 로 풀어쓴다. 
  * 중간 테이블에 대한 커스텀이 거의 안 되기 때문임.
* 외래 키가 있는 곳을 연관관계의 주인으로 사용하라.
* FK 를 잡을지는 시스템 특성에 따라 다르다.
  * 데이터 정합성을 어느정도 포기하고 실시간 트래픽에 강하게 하려면 안 잡고 인덱스만 잘 잡고 갈 수도 있고
  * 데이터 정합성이 가장 중요한 경우라면 `(ex. 돈)` FK를 쓰는 것이 좋을 수 있다.
* Setter 를 호출하면 데이터가 바뀐다. 이 때문에 Setter를 함부로 열어두면 데이터가 왜 변경된건지 추적이 점점 힘들어진다.
  * 그래도 엔티티를 변경할 때는 Setter 대신 변경 지점이 명확하도록 변경을 위한 비즈니스 메서드를 별도로 제공해야한다.
* Getter 는 사이드이펙이 딱히 없으니 다 열어둬도 된다.
* JPA가 직접 만드는 DDL을 운영에서 쓰면 안 되고 목적에 맞게 튜닝한 다음 직접 만들어야한다.
  * 단, DDL 초안 생성용으로는 좋다.

## 엔티티 설계 주의점

* 모든 연관관계는 지연로딩으로 설정해야한다.
  * 즉시로딩 `EAGER` 는 예측이 어렵고 어떤 SQL이 실행될지 추적이 어렵다. 또한 JPQL을 실행할 때 N+1 문제가 자주 발생한다.
  * 실무에서 모든 연관관계는 LAZY로 설정해야한다.
* 연관된 엔티티를 함께 조회해야한다면 fetch join 또는 엔티티 그래프 기능을 사용한다.
* @XToOne(OneToOne, ManyToOne) 은 기본이 EAGER이므로 명시적으로 LAZY로 설정하자.
  * @OneToMany 는 LAZY로 되어있으므로 혼동하면 안 됨.

## 컬렉션 초기화

* 컬렉션은 필드레벨에서 초기화해두는게 좋다.
  * NPE 에서 안전하다.

## 연관관계 세팅

* 코드상에서 객체간의 연관관계를 따로따로 잡아줘도 되지만
* 실수를 방지하기 위해 `연관관계 편의 메서드` 를 관계의 핵심 엔티티에 정의해두면 연관관계를 원자적으로 설정해줄 수 있어 실수를 막을 수 있다.